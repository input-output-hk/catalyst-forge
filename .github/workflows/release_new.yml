on:
  workflow_call:
    inputs:
      releases:
        description: |
          A JSON list of releases to run
        required: true
        type: string
      forge_version:
        description: |
          The version of the forge CLI to install (use 'local' for testing)
        required: true
        type: string
    secrets:
      earthly_token:
        description: Optional Earthly token used to login to Earthly cloud during local builds of Forge CLI
        required: false
env:
  OUTPUT: ${{ github.workspace }}/output

jobs:
  run:
    name: ${{ matrix.release.project }} (${{ matrix.release.name}})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        release: ${{ fromJson(inputs.releases) }}
    steps:
      - uses: actions/checkout@v4
      - name: Install Forge
        uses: input-output-hk/catalyst-forge/actions/install@adds-release-cm
        if: ${{ inputs.forge_version != 'local' }}
        with:
          version: ${{ inputs.forge_version }}
      - name: Install Local Forge
        uses: input-output-hk/catalyst-forge/actions/install-local@adds-release-cm
        if: ${{ inputs.forge_version == 'local' }}
        with:
          earthly_token: ${{ secrets.earthly_token }}
      - name: Check forge version
        id: local
        run: |
          forge version

          if [[ "${{ inputs.forge_version }}" == "local" ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
      - name: Setup CI
        uses: input-output-hk/catalyst-forge/actions/setup@adds-release-cm
        with:
          skip_earthly: ${{ steps.local.outputs.skip }}
      - name: Run
        run: |
          forge -vv release ${{ matrix.release.project }} ${{ matrix.release.name }}