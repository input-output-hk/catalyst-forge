VERSION 0.8

deps:
    FROM golang:1.24.5-bookworm

    WORKDIR /work/renderer

    RUN mkdir -p /go/cache && mkdir -p /go/modcache
    ENV GOCACHE=/go/cache
    ENV GOMODCACHE=/go/modcache
    CACHE --persist --sharing shared /go

    COPY ../../lib/deployment+src/src /lib/deployment/
    COPY ../../lib/schema+src/src /lib/schema/
    COPY ../../lib/providers+src/src /lib/providers/
    COPY ../../lib/project+src/src /lib/project/
    COPY ../../lib/tools+src/src /lib/tools/
    COPY ../../lib/external/kcl+src/src /lib/external/kcl/
    COPY ../../lib/external/helm+src/src /lib/external/helm/
    COPY ../../lib/oci+src/src /lib/oci/

    COPY go.mod go.sum .

    RUN go mod download

proto:
    FROM golang:1.24.5-bookworm

    WORKDIR /work

    RUN apt-get update && apt-get install -y protobuf-compiler
    RUN go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
    RUN go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

    ENV PATH=$PATH:/go/bin

proto-gen:
    FROM +proto

    WORKDIR /work

    COPY proto/ proto/
    COPY ../../lib/schema+src/src/proto/ lib/schema/proto/
    RUN mkdir -p pkg/proto

    # Generate Go and gRPC code
    RUN protoc \
        --go_out=pkg/proto \
        --go_opt=paths=source_relative \
        --go-grpc_out=pkg/proto \
        --go-grpc_opt=paths=source_relative \
        --proto_path=proto \
        --proto_path=lib/schema/proto \
        proto/renderer.proto

    SAVE ARTIFACT pkg/proto pkg/proto AS LOCAL pkg/proto

src:
    FROM +deps

    CACHE --persist --sharing shared /go

    COPY --dir cmd internal pkg proto .
    RUN go generate ./...

    SAVE ARTIFACT . src

check:
    FROM +src

    RUN gofmt -l . | grep . && exit 1 || exit 0
    RUN go vet ./...

build:
    FROM +src

    ARG GOOS
    ARG GOARCH
    ARG version="0.0.0"

    ENV CGO_ENABLED=0
    RUN go build -ldflags="-extldflags=-static -X main.version=$version" -o bin/renderer cmd/renderer/main.go

    SAVE ARTIFACT bin/renderer renderer

test:
    FROM earthly/dind:ubuntu-24.04-docker-27.3.1-1

    COPY docker-compose.yml .
    COPY --dir test .

    WITH DOCKER \
        --load certs:latest=+certs \
        --load renderer:latest=+docker \
        --load kcl-publisher:latest=+kcl-publisher \
        --load renderer-test:latest=+docker-test \
        --compose docker-compose.yml \
        --service certs \
        --service renderer \
        --service kcl-publisher
        RUN docker compose up renderer-test --abort-on-container-exit --exit-code-from renderer-test
    END

docker:
    FROM debian:bookworm-slim

    WORKDIR /app

    ARG container="renderer"
    ARG tag="latest"
    ARG version="dev"

    ARG TARGETOS
    ARG TARGETARCH
    ARG TARGETPLATFORM

    ENV PATH="/usr/local:$PATH"

    RUN apt-get update && apt-get install -y ca-certificates curl wget tar

    RUN if [ "$TARGETARCH" = "amd64" ]; then \
        wget -q https://github.com/kcl-lang/cli/releases/download/v0.11.0/kcl-v0.11.0-linux-amd64.tar.gz && \
        tar -xzf kcl-v0.11.0-linux-amd64.tar.gz -C /usr/local && \
        rm kcl-v0.11.0-linux-amd64.tar.gz; \
    elif [ "$TARGETARCH" = "arm64" ]; then \
        wget -q https://github.com/kcl-lang/cli/releases/download/v0.11.0/kcl-v0.11.0-linux-arm64.tar.gz && \
        tar -xzf kcl-v0.11.0-linux-arm64.tar.gz -C /usr/local && \
        rm kcl-v0.11.0-linux-arm64.tar.gz; \
    fi && \
    chmod +x /usr/local/kcl

    RUN curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 && \
        chmod 700 get_helm.sh && \
        ./get_helm.sh && \
        rm get_helm.sh

    COPY \
        --platform=$TARGETPLATFORM \
        (+build/renderer \
        --GOOS=$TARGETOS \
        --GOARCH=$TARGETARCH \
        --version=$version) renderer

    ENTRYPOINT ["/app/renderer"]
    SAVE IMAGE ${container}:${tag}

docker-test:
    FROM +src

    COPY --dir test .

    ENTRYPOINT ["/usr/local/go/bin/go", "test", "-v", "./test/..."]
    SAVE IMAGE renderer-test:latest

certs:
   FROM debian:bookworm-slim

    RUN apt-get update && apt-get install -y openssl bash

    WORKDIR /data
    COPY test/scripts/generate-certs.sh ./
    RUN chmod +x generate-certs.sh

    ENTRYPOINT ["./generate-certs.sh"]
    SAVE IMAGE certs:latest

kcl-publisher:
    FROM debian:bookworm-slim

    WORKDIR /workspace
    ENV PATH="/usr/local:$PATH"

    RUN apt-get update && apt-get install -y curl tar bash wget jq ca-certificates && \
        rm -rf /var/lib/apt/lists/*

    RUN ARCH=$(uname -m) && \
        if [ "$ARCH" = "x86_64" ]; then ARCH="amd64"; fi && \
        if [ "$ARCH" = "aarch64" ]; then ARCH="arm64"; fi && \
        wget -q https://github.com/kcl-lang/cli/releases/download/v0.11.0/kcl-v0.11.0-linux-$ARCH.tar.gz && \
        tar -xzf kcl-v0.11.0-linux-$ARCH.tar.gz -C /usr/local && \
        rm kcl-v0.11.0-linux-$ARCH.tar.gz && \
        chmod +x /usr/local/kcl && \
        /usr/local/kcl version

    COPY ../../modules/examples/app+src/module ./kcl-module/
    COPY test/scripts/publish.sh ./
    RUN chmod +x publish.sh

    ENTRYPOINT ["./publish.sh"]
    SAVE IMAGE kcl-publisher:latest